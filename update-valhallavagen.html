<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uppdatera Valhallavägen Postnummer</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .results {
            border: 1px solid #ccc;
            padding: 15px;
            margin-top: 20px;
            background-color: #f9f9f9;
            white-space: pre-wrap;
            max-height: 500px;
            overflow-y: auto;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 10px 0;
            cursor: pointer;
            border-radius: 4px;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            background-color: #e6f7ff;
            border-left: 4px solid #1890ff;
        }
        .error {
            background-color: #fff1f0;
            border-left: 4px solid #f5222d;
        }
        .success {
            background-color: #f6ffed;
            border-left: 4px solid #52c41a;
        }
    </style>
</head>
<body>
    <h1>Uppdatera Postnummer för Valhallavägen till 37141</h1>
    <p>Detta verktyg uppdaterar postnumret för alla lägenheter och hyresgäster med adressen Valhallavägen till 37141 direkt i databasen.</p>
    
    <div>
        <p><strong>Instruktioner:</strong></p>
        <ol>
            <li>Se till att du är inloggad i systemet i en annan flik</li>
            <li>Se till att backend-servern är igång på <code>http://localhost:8080</code></li>
            <li>Klicka på "Uppdatera Postnummer"-knappen nedan</li>
        </ol>
    </div>
    
    <button id="updateBtn">Uppdatera Postnummer</button>
    
    <div id="status" class="status" style="display: none;">Processar...</div>
    
    <div id="results" class="results" style="display: none;"></div>
    
    <script>
        // Hämta referenser till DOM-element
        const updateBtn = document.getElementById('updateBtn');
        const statusEl = document.getElementById('status');
        const resultsEl = document.getElementById('results');
        
        // API URL
        const API_URL = 'http://localhost:8080/api';
        
        // Funktion för att hämta token från localStorage
        function getToken() {
            return localStorage.getItem('auth_token');
        }
        
        // Loggfunktion som också visar resultatet på sidan
        function log(message, append = true) {
            console.log(message);
            
            if (append) {
                resultsEl.textContent += message + '\n';
            } else {
                resultsEl.textContent = message + '\n';
            }
            
            resultsEl.style.display = 'block';
            resultsEl.scrollTop = resultsEl.scrollHeight; // Auto-scroll till botten
        }
        
        // Funktion för att sätta statusmeddelande
        function setStatus(message, type = '') {
            statusEl.textContent = message;
            statusEl.style.display = 'block';
            
            // Återställ klasser
            statusEl.classList.remove('error', 'success');
            
            // Lägg till klasstyp om det finns
            if (type) {
                statusEl.classList.add(type);
            }
        }
        
        // Funktion för att hämta alla lägenheter
        async function getAllApartments(token) {
            try {
                const response = await fetch(`${API_URL}/apartments`, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                
                if (!response.ok) {
                    throw new Error(`Kunde inte hämta lägenheter: ${response.status} ${response.statusText}`);
                }
                
                return await response.json();
            } catch (error) {
                log(`Fel vid hämtning av lägenheter: ${error.message}`);
                return [];
            }
        }
        
        // Funktion för att hämta alla hyresgäster
        async function getAllTenants(token) {
            try {
                const response = await fetch(`${API_URL}/tenants`, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                
                if (!response.ok) {
                    throw new Error(`Kunde inte hämta hyresgäster: ${response.status} ${response.statusText}`);
                }
                
                return await response.json();
            } catch (error) {
                log(`Fel vid hämtning av hyresgäster: ${error.message}`);
                return [];
            }
        }
        
        // Funktion för att uppdatera en lägenhet
        async function updateApartment(id, data, token) {
            try {
                const response = await fetch(`${API_URL}/apartments/${id}`, {
                    method: 'PATCH',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` 
                    },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) {
                    throw new Error(`Kunde inte uppdatera lägenhet: ${response.status} ${response.statusText}`);
                }
                
                return await response.json();
            } catch (error) {
                log(`Fel vid uppdatering av lägenhet ${id}: ${error.message}`);
                return null;
            }
        }
        
        // Funktion för att uppdatera en hyresgäst
        async function updateTenant(id, data, token) {
            try {
                const response = await fetch(`${API_URL}/tenants/${id}`, {
                    method: 'PATCH',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` 
                    },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) {
                    throw new Error(`Kunde inte uppdatera hyresgäst: ${response.status} ${response.statusText}`);
                }
                
                return await response.json();
            } catch (error) {
                log(`Fel vid uppdatering av hyresgäst ${id}: ${error.message}`);
                return null;
            }
        }
        
        // Huvudfunktion för att uppdatera alla Valhallavägen-adresser
        async function updateValhallaAddresses() {
            const token = getToken();
            
            if (!token) {
                setStatus('Ingen token hittades. Du måste vara inloggad i systemet.', 'error');
                return false;
            }
            
            log('Startar uppdatering av postnummer för Valhallavägen...', false);
            log(`Använder token: ${token.substring(0, 10)}...`);
            
            // Hämta alla lägenheter och hyresgäster
            log('Hämtar lägenheter och hyresgäster...');
            
            setStatus('Hämtar data från databasen...');
            const apartments = await getAllApartments(token);
            const tenants = await getAllTenants(token);
            
            log(`Hittade ${apartments.length} lägenheter och ${tenants.length} hyresgäster`);
            
            // Filtrera ut lägenheter på Valhallavägen
            const valhallaApartments = apartments.filter(apt => 
                apt.street && apt.street.toLowerCase().includes('valhallavägen')
            );
            
            log(`Hittade ${valhallaApartments.length} lägenheter på Valhallavägen`);
            
            // Uppdatera postnummer för alla Valhallavägen-lägenheter
            let updatedApartments = 0;
            
            setStatus(`Uppdaterar ${valhallaApartments.length} lägenheter...`);
            for (const apt of valhallaApartments) {
                log(`Uppdaterar lägenhet ${apt.id} (${apt.street} ${apt.number}): ${apt.postalCode || 'inget postnummer'} -> 37141`);
                
                const updated = await updateApartment(apt.id, { postalCode: '37141' }, token);
                if (updated) updatedApartments++;
            }
            
            // Filtrera ut hyresgäster på Valhallavägen
            const valhallaTenants = tenants.filter(tenant => 
                tenant.street && tenant.street.toLowerCase().includes('valhallavägen')
            );
            
            log(`Hittade ${valhallaTenants.length} hyresgäster på Valhallavägen`);
            
            // Uppdatera postnummer för alla Valhallavägen-hyresgäster
            let updatedTenants = 0;
            
            setStatus(`Uppdaterar ${valhallaTenants.length} hyresgäster...`);
            for (const tenant of valhallaTenants) {
                log(`Uppdaterar hyresgäst ${tenant.id} (${tenant.firstName} ${tenant.lastName}, ${tenant.street} ${tenant.number}): ${tenant.postalCode || 'inget postnummer'} -> 37141`);
                
                const updated = await updateTenant(tenant.id, { postalCode: '37141' }, token);
                if (updated) updatedTenants++;
            }
            
            log(`\nUppdateringen klar!`);
            log(`Totalt uppdaterade: ${updatedApartments} lägenheter och ${updatedTenants} hyresgäster.`);
            
            setStatus(`Uppdateringen slutförd! Uppdaterade ${updatedApartments} lägenheter och ${updatedTenants} hyresgäster.`, 'success');
            
            return true;
        }
        
        // Lägg till klickhändelse på uppdateringsknappen
        updateBtn.addEventListener('click', async () => {
            // Disable button during operation
            updateBtn.disabled = true;
            
            try {
                await updateValhallaAddresses();
            } catch (error) {
                setStatus(`Ett oväntat fel inträffade: ${error.message}`, 'error');
                log(`ERROR: ${error.message}`);
                log(error.stack);
            } finally {
                // Återaktivera knappen när vi är klara
                updateBtn.disabled = false;
            }
        });
    </script>
</body>
</html> 